import {useEffect, useReducer, createContext, Dispatch} from 'react';
import {Action, MessageFromIframe, MessageToIframe, State} from '../../types';
import {reducer} from '../../reducer';
import Inspector from '../Inspector';
import LayerList from '../LayerList';
import styles from './App.module.scss';
import AppStateEditor from '../AppStateEditor';
import LayerAdder from '../LayerAdder';
import 'react-tooltip/dist/react-tooltip.css';
import {className} from '../../utils';

const CANVAS_IFRAME_ID = 'canvas';

export const initialState: State = {
  hoveredLayerId: null,
  layers: [],
  views: [
    {
      id: 'a',
      name: 'Index',
      selectedLayerId: null,
      type: 'View',
    },
    {
      id: 'b',
      name: 'Details',
      selectedLayerId: null,
      type: 'View',
    },
    {
      id: 'c',
      name: 'Custom component',
      selectedLayerId: null,
      type: 'CustomComponent',
    },
  ],
  selectedViewId: 'a',
  layerAdderVisibility: false,
  appState: {
    sheets: [],
  },
};

export const StateContext = createContext<{
  state: State;
  dispatch: Dispatch<Action>;
}>({
  state: initialState,
  dispatch: () => undefined,
});

export default function App() {
  const [state, dispatch] = useReducer(reducer, initialState);

  useEffect(() => {
    const listener = (event: MessageEvent<MessageFromIframe>) => {
      const {source, action} = event.data;
      if (source !== 'polaris-studio') return;
      console.log({log: 'App recieved a message...', action});
      dispatch(action);
    };

    window.addEventListener('message', listener, false);
    console.log({log: 'App is listening for messages...'});
    return () => window.removeEventListener('message', listener);
  }, []);

  useEffect(() => {
    const iframe = document.querySelector<HTMLIFrameElement>(
      `#${CANVAS_IFRAME_ID}`,
    );
    if (!iframe) return;

    const message: MessageToIframe = {source: 'polaris-studio', state};
    iframe.contentWindow?.postMessage(message);
    console.log({log: 'App is sending a message...', message});
  }, [state]);

  return (
    <StateContext.Provider value={{state, dispatch}}>
      <div className={styles.Loading}>
        <Logo />
        <div className={styles.ProgressBar}>
          <div></div>
        </div>
      </div>

      <div className={className(styles.App, 'reset-non-canvas-styles')}>
        <div className={styles.TopBar}>
          <Logo />
        </div>

        <div className={styles.Columns}>
          <div className={styles.Left}>
            <LayerList />
          </div>

          <div className={styles.Center}>
            <iframe
              id={CANVAS_IFRAME_ID}
              src={`/canvas`}
              width={1000}
              height={500}
              className={styles.Canvas}
              title="Canvas"
            ></iframe>

            <AppStateEditor />
          </div>

          <div className={styles.Right}>
            <Inspector />
          </div>

          <LayerAdder />
        </div>
      </div>
    </StateContext.Provider>
  );
}

function Logo() {
  return (
    <svg
      width="549"
      height="57"
      viewBox="0 0 549 57"
      fill="none"
      xmlns="http://www.w3.org/2000/svg"
    >
      <path
        d="M6.89844 39.8477H31.2266C35.4922 39.8477 39.1602 39.0977 42.2305 37.5977C45.3242 36.0977 47.7031 34.0117 49.3672 31.3398C51.0547 28.668 51.8984 25.5742 51.8984 22.0586V21.9883C51.8984 18.4492 51.0547 15.3555 49.3672 12.707C47.7031 10.0352 45.3242 7.96094 42.2305 6.48438C39.1602 5.00781 35.4922 4.26953 31.2266 4.26953H6.89844V14.1836H28.9766C31.9531 14.1836 34.2383 14.875 35.832 16.2578C37.4492 17.6172 38.2578 19.5742 38.2578 22.1289V22.1992C38.2578 24.7773 37.4492 26.7578 35.832 28.1406C34.2383 29.5 31.9531 30.1797 28.9766 30.1797H6.89844V39.8477ZM0.148438 55H13.6133V4.26953H0.148438V55Z"
        fill="white"
      />
      <path
        d="M77.5287 55.9141C82.4975 55.9141 86.81 55.1172 90.4662 53.5234C94.1459 51.9062 96.9936 49.6211 99.0092 46.668C101.025 43.7148 102.033 40.1992 102.033 36.1211V36.0508C102.033 31.9961 101.013 28.4922 98.9741 25.5391C96.9584 22.5859 94.1108 20.3125 90.4311 18.7188C86.7748 17.1016 82.4741 16.293 77.5287 16.293C72.5834 16.293 68.2709 17.1016 64.5912 18.7188C60.935 20.3125 58.0873 22.5859 56.0483 25.5391C54.0327 28.4922 53.0248 31.9961 53.0248 36.0508V36.1211C53.0248 40.1992 54.0327 43.7148 56.0483 46.668C58.0639 49.6211 60.8998 51.9062 64.5561 53.5234C68.2358 55.1172 72.56 55.9141 77.5287 55.9141ZM77.5287 46.7734C75.2787 46.7734 73.31 46.3633 71.6225 45.543C69.935 44.6992 68.6225 43.4922 67.685 41.9219C66.7475 40.3281 66.2787 38.3945 66.2787 36.1211V36.0508C66.2787 33.8008 66.7475 31.8906 67.685 30.3203C68.6225 28.7266 69.935 27.5195 71.6225 26.6992C73.3334 25.8555 75.3022 25.4336 77.5287 25.4336C79.7553 25.4336 81.7123 25.8555 83.3998 26.6992C85.0873 27.5195 86.3998 28.7266 87.3373 30.3203C88.2983 31.8906 88.7787 33.8008 88.7787 36.0508V36.1211C88.7787 38.3945 88.31 40.3281 87.3725 41.9219C86.435 43.4922 85.1225 44.6992 83.435 45.543C81.7475 46.3633 79.7787 46.7734 77.5287 46.7734Z"
        fill="white"
      />
      <path d="M106.042 55H119.085V4.26953H106.042V55Z" fill="white" />
      <path
        d="M139.758 55.5977C142.102 55.5977 144.258 55.3281 146.227 54.7891C148.219 54.25 149.953 53.4766 151.43 52.4688C152.93 51.4609 154.125 50.2539 155.016 48.8477H155.227V55H168.27V31.1289C168.27 28.0352 167.391 25.3867 165.633 23.1836C163.899 20.957 161.403 19.2578 158.145 18.0859C154.887 16.8906 150.996 16.293 146.473 16.293C142.231 16.293 138.598 16.8438 135.575 17.9453C132.551 19.0469 130.16 20.5703 128.403 22.5156C126.668 24.4375 125.578 26.6641 125.133 29.1953L125.063 29.6172H137.262L137.367 29.3008C137.766 27.9883 138.703 26.9336 140.18 26.1367C141.657 25.3164 143.66 24.9062 146.192 24.9062C149.098 24.9062 151.325 25.4688 152.871 26.5938C154.442 27.6953 155.227 29.2422 155.227 31.2344V39.8828C155.227 41.4297 154.758 42.7891 153.821 43.9609C152.883 45.1094 151.547 46 149.813 46.6328C148.102 47.2422 146.086 47.5469 143.766 47.5469C141.422 47.5469 139.535 47.1836 138.106 46.457C136.676 45.707 135.961 44.5703 135.961 43.0469V43.0117C135.961 41.8164 136.465 40.8789 137.473 40.1992C138.504 39.4961 140.157 39.1211 142.43 39.0742L161.801 38.6172V32.043L140.285 32.5C136.254 32.5938 132.973 33.1094 130.442 34.0469C127.934 34.9844 126.094 36.2852 124.922 37.9492C123.774 39.5898 123.2 41.5234 123.2 43.75V43.8203C123.2 46.3281 123.879 48.4609 125.239 50.2188C126.598 51.9766 128.52 53.3125 131.004 54.2266C133.489 55.1406 136.407 55.5977 139.758 55.5977Z"
        fill="white"
      />
      <path
        d="M173.369 55H186.377V37.7383C186.377 35.2305 186.834 33.168 187.748 31.5508C188.662 29.9102 189.951 28.6914 191.615 27.8945C193.303 27.0742 195.271 26.6641 197.521 26.6641C198.365 26.6641 199.185 26.7109 199.982 26.8047C200.779 26.875 201.506 26.9922 202.162 27.1562V16.8906C201.646 16.75 201.049 16.6445 200.369 16.5742C199.713 16.4805 199.021 16.4336 198.295 16.4336C195.295 16.4336 192.787 17.1719 190.771 18.6484C188.756 20.125 187.373 22.2344 186.623 24.9766H186.377V17.2773L173.369 17.207V55Z"
        fill="white"
      />
      <path
        d="M205.011 55H218.054V17.207H205.011V55ZM211.55 12.8828C213.589 12.8828 215.253 12.3086 216.542 11.1602C217.831 9.98828 218.476 8.54688 218.476 6.83594C218.476 5.125 217.831 3.69531 216.542 2.54688C215.253 1.375 213.589 0.789062 211.55 0.789062C209.511 0.789062 207.835 1.375 206.523 2.54688C205.234 3.69531 204.589 5.125 204.589 6.83594C204.589 8.54688 205.234 9.98828 206.523 11.1602C207.835 12.3086 209.511 12.8828 211.55 12.8828Z"
        fill="white"
      />
      <path
        d="M244.95 55.9141C249.45 55.9141 253.305 55.4102 256.516 54.4023C259.727 53.3711 262.188 51.9062 263.899 50.0078C265.61 48.0859 266.465 45.7891 266.465 43.1172V43.082C266.465 40.0117 265.352 37.5977 263.126 35.8398C260.899 34.082 257.231 32.9453 252.122 32.4297L241.645 31.4453C240.169 31.2812 238.985 31.0586 238.094 30.7773C237.204 30.4961 236.559 30.1328 236.161 29.6875C235.762 29.2188 235.563 28.6562 235.563 28V27.9648C235.563 27.168 235.88 26.4883 236.512 25.9258C237.145 25.3398 238.059 24.8945 239.255 24.5898C240.473 24.2852 241.95 24.1328 243.684 24.1328C246.497 24.1328 248.723 24.5195 250.364 25.293C252.005 26.0664 252.942 27.1328 253.176 28.4922L253.212 28.7031H265.2L265.165 28.3516C264.977 25.8906 264.028 23.7695 262.317 21.9883C260.606 20.1836 258.169 18.7891 255.005 17.8047C251.864 16.7969 248.044 16.293 243.544 16.293C239.231 16.293 235.528 16.7852 232.434 17.7695C229.364 18.7305 227.008 20.1367 225.368 21.9883C223.727 23.8398 222.907 26.0547 222.907 28.6328V28.7031C222.907 30.7656 223.423 32.5703 224.454 34.1172C225.508 35.6406 227.079 36.8828 229.165 37.8438C231.274 38.7812 233.923 39.4258 237.11 39.7773L247.34 40.7617C249.637 41.0195 251.231 41.4062 252.122 41.9219C253.036 42.4141 253.493 43.1758 253.493 44.207V44.2422C253.493 45.0625 253.165 45.7539 252.508 46.3164C251.852 46.8789 250.903 47.3125 249.661 47.6172C248.419 47.9219 246.883 48.0742 245.055 48.0742C241.938 48.0742 239.501 47.7227 237.743 47.0195C235.985 46.3164 234.919 45.2266 234.544 43.75L234.473 43.5039L221.782 43.4688L221.817 43.7852C222.098 46.3164 223.165 48.4844 225.016 50.2891C226.891 52.0938 229.505 53.4883 232.856 54.4727C236.208 55.4336 240.239 55.9141 244.95 55.9141Z"
        fill="white"
      />
      <path
        d="M313.929 56.0195C319.484 56.0195 324.218 55.3516 328.132 54.0156C332.07 52.6797 335.07 50.7695 337.132 48.2852C339.218 45.7773 340.261 42.7656 340.261 39.25V39.2148C340.261 36.3555 339.593 33.9414 338.257 31.9727C336.921 29.9805 334.882 28.3984 332.14 27.2266C329.398 26.0547 325.918 25.2578 321.699 24.8359L308.972 23.8164C305.785 23.4883 303.5 22.9258 302.117 22.1289C300.734 21.332 300.043 20.1719 300.043 18.6484V18.6133C300.043 17.4414 300.5 16.4336 301.414 15.5898C302.328 14.7227 303.675 14.0664 305.457 13.6211C307.261 13.1523 309.476 12.918 312.101 12.918C314.843 12.918 317.175 13.1406 319.097 13.5859C321.043 14.0312 322.578 14.7109 323.703 15.625C324.851 16.5156 325.601 17.6289 325.953 18.9648L326.058 19.2812H339.066L338.96 18.7188C338.492 15.4609 337.144 12.6836 334.918 10.3867C332.691 8.06641 329.644 6.29688 325.777 5.07812C321.933 3.85938 317.351 3.25 312.031 3.25C306.781 3.25 302.246 3.90625 298.425 5.21875C294.628 6.50781 291.699 8.35938 289.636 10.7734C287.597 13.1641 286.578 16.0234 286.578 19.3516V19.4219C286.578 23.6641 288.125 26.9805 291.218 29.3711C294.312 31.7383 298.988 33.2266 305.246 33.8359L317.796 34.8203C321.125 35.1953 323.457 35.7812 324.793 36.5781C326.128 37.3516 326.796 38.5469 326.796 40.1641V40.1992C326.796 41.4648 326.293 42.5664 325.285 43.5039C324.3 44.418 322.871 45.1211 320.996 45.6133C319.121 46.1055 316.871 46.3516 314.246 46.3516C311.128 46.3516 308.457 46.1172 306.23 45.6484C304.003 45.1562 302.234 44.4531 300.921 43.5391C299.632 42.6016 298.812 41.4648 298.46 40.1289L298.39 39.8125H285.382L285.418 40.3047C285.886 43.6562 287.293 46.5039 289.636 48.8477C292.003 51.1914 295.226 52.9727 299.304 54.1914C303.382 55.4102 308.257 56.0195 313.929 56.0195Z"
        fill="white"
      />
      <path
        d="M366.138 55.5977C367.567 55.5977 368.938 55.5391 370.251 55.4219C371.563 55.3047 372.747 55.1641 373.802 55V46.3516C373.263 46.4453 372.642 46.5273 371.938 46.5977C371.259 46.668 370.532 46.7031 369.759 46.7031C367.11 46.7031 365.224 46.2461 364.099 45.332C362.974 44.418 362.411 42.8594 362.411 40.6562V26.0664H373.802V17.207H362.376V8.06641H349.368V17.207H341.88V26.0664H349.368V42.3438C349.368 47.0078 350.704 50.3828 353.376 52.4688C356.048 54.5547 360.302 55.5977 366.138 55.5977Z"
        fill="white"
      />
      <path
        d="M394.616 55.9141C397.123 55.9141 399.385 55.5859 401.401 54.9297C403.416 54.25 405.163 53.2891 406.639 52.0469C408.116 50.7812 409.288 49.3047 410.155 47.6172H410.401V55H423.409V17.207H410.401V35.9453C410.401 37.5625 410.143 39.0156 409.627 40.3047C409.135 41.5703 408.42 42.6484 407.483 43.5391C406.569 44.4297 405.479 45.1094 404.213 45.5781C402.948 46.0469 401.53 46.2812 399.959 46.2812C396.959 46.2812 394.674 45.4375 393.104 43.75C391.557 42.0625 390.784 39.6367 390.784 36.4727V17.207H377.741V39.1797C377.741 42.7422 378.42 45.7773 379.78 48.2852C381.139 50.7695 383.073 52.668 385.58 53.9805C388.112 55.2695 391.123 55.9141 394.616 55.9141Z"
        fill="white"
      />
      <path
        d="M447.211 55.9141C449.836 55.9141 452.191 55.5859 454.277 54.9297C456.363 54.2734 458.168 53.3594 459.691 52.1875C461.215 51.0156 462.445 49.6445 463.383 48.0742H463.594V55H476.637V4.26953H463.594V24.168H463.383C462.445 22.5977 461.203 21.2266 459.656 20.0547C458.133 18.8594 456.328 17.9336 454.242 17.2773C452.156 16.6211 449.812 16.293 447.211 16.293C443.203 16.293 439.699 17.1133 436.699 18.7539C433.699 20.3711 431.367 22.668 429.703 25.6445C428.062 28.5977 427.242 32.0664 427.242 36.0508V36.1211C427.242 40.1055 428.062 43.5859 429.703 46.5625C431.367 49.5156 433.699 51.8125 436.699 53.4531C439.699 55.0938 443.203 55.9141 447.211 55.9141ZM451.957 46.5977C449.613 46.5977 447.574 46.1758 445.84 45.332C444.129 44.4883 442.805 43.293 441.867 41.7461C440.953 40.1758 440.496 38.3008 440.496 36.1211V36.0508C440.496 33.8945 440.953 32.0312 441.867 30.4609C442.805 28.8906 444.129 27.6953 445.84 26.875C447.574 26.0312 449.613 25.6094 451.957 25.6094C454.324 25.6094 456.375 26.043 458.109 26.9102C459.844 27.7539 461.191 28.9609 462.152 30.5312C463.113 32.0781 463.594 33.9297 463.594 36.0859V36.1211C463.594 38.2773 463.113 40.1406 462.152 41.7109C461.191 43.2578 459.844 44.4648 458.109 45.332C456.375 46.1758 454.324 46.5977 451.957 46.5977Z"
        fill="white"
      />
      <path
        d="M482.087 55H495.13V17.207H482.087V55ZM488.626 12.8828C490.665 12.8828 492.329 12.3086 493.618 11.1602C494.908 9.98828 495.552 8.54688 495.552 6.83594C495.552 5.125 494.908 3.69531 493.618 2.54688C492.329 1.375 490.665 0.789062 488.626 0.789062C486.587 0.789062 484.911 1.375 483.599 2.54688C482.31 3.69531 481.665 5.125 481.665 6.83594C481.665 8.54688 482.31 9.98828 483.599 11.1602C484.911 12.3086 486.587 12.8828 488.626 12.8828Z"
        fill="white"
      />
      <path
        d="M523.608 55.9141C528.577 55.9141 532.889 55.1172 536.546 53.5234C540.225 51.9062 543.073 49.6211 545.089 46.668C547.104 43.7148 548.112 40.1992 548.112 36.1211V36.0508C548.112 31.9961 547.093 28.4922 545.053 25.5391C543.038 22.5859 540.19 20.3125 536.51 18.7188C532.854 17.1016 528.553 16.293 523.608 16.293C518.663 16.293 514.35 17.1016 510.671 18.7188C507.014 20.3125 504.167 22.5859 502.128 25.5391C500.112 28.4922 499.104 31.9961 499.104 36.0508V36.1211C499.104 40.1992 500.112 43.7148 502.128 46.668C504.143 49.6211 506.979 51.9062 510.635 53.5234C514.315 55.1172 518.639 55.9141 523.608 55.9141ZM523.608 46.7734C521.358 46.7734 519.389 46.3633 517.702 45.543C516.014 44.6992 514.702 43.4922 513.764 41.9219C512.827 40.3281 512.358 38.3945 512.358 36.1211V36.0508C512.358 33.8008 512.827 31.8906 513.764 30.3203C514.702 28.7266 516.014 27.5195 517.702 26.6992C519.413 25.8555 521.382 25.4336 523.608 25.4336C525.835 25.4336 527.792 25.8555 529.479 26.6992C531.167 27.5195 532.479 28.7266 533.417 30.3203C534.378 31.8906 534.858 33.8008 534.858 36.0508V36.1211C534.858 38.3945 534.389 40.3281 533.452 41.9219C532.514 43.4922 531.202 44.6992 529.514 45.543C527.827 46.3633 525.858 46.7734 523.608 46.7734Z"
        fill="white"
      />
    </svg>
  );
}
