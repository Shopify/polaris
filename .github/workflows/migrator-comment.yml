name: Migrator comment in diff

on:
  pull_request:
    types:
      - labeled
      - unlabeled
      - opened
      - synchronize
      - reopened

env:
  COMMENT: 'generated by polaris-migrator DO NOT COPY'

jobs:
  check-diff:
    if: |
      !contains(github.event.pull_request.labels.*.name, 'ðŸ¤–Skip Comment Check')
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Fetch all branches
        run: git fetch --all

      - name: Checkout the feature branch
        run: git checkout ${{ github.head_ref }}

      - name: Check for generic migrator comment in diff
        run: |
          # The "|| true" is used so that matches are saved but it always exit with status 0.
          # Without this, grep will exit with a status of 1 when no matches are found, ending the script.
          files=$(git diff --name-only --diff-filter=d origin/${{ github.base_ref }}...origin/${{ github.head_ref }} | grep "\.scss$" || true)

          if [ -n "$files" ]; then
            echo "SCSS files where modified."
            echo "$files"
          else
            echo "No SCSS files where modified."
            exit 0
          fi

          filesWithComment=$(git diff --unified=0 origin/${{ github.base_ref }}...origin/${{ github.head_ref }} -- "$files" | grep "^\+.*$COMMENT")

          if [ -n "$filesWithComment" ]; then
            echo "A migrator comment '$COMMENT' was added to a SCSS file in this PR."
            echo "Please replace this with a disable description."
            exit 1
          else
            echo "All good, no migrator comments were added."
          fi
